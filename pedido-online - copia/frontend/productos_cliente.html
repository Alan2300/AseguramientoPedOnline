<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Productos Disponibles</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    header { background: #007bff; color: white; padding: 15px; text-align: center; }
    .container { max-width: 1200px; margin: auto; padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .card { background: white; border-radius: 10px; padding: 15px; width: 260px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; position: relative; }
    .thumb { position: relative; display: inline-block; }
    .thumb img { width: 160px; height: 160px; object-fit: cover; border-radius: 10px; }
    .zoom-badge { position:absolute; left:50%; transform:translateX(-50%); bottom:-10px; background:#1f2937; color:#fff; font-size:12px; padding:6px 10px; border-radius:999px; box-shadow:0 4px 10px rgba(0,0,0,.15); }
    .card input { width: 60px; margin-top: 10px; }
    .card button { margin-top: 10px; padding: 8px 15px; background: green; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .card button:disabled { background: grey; cursor: not-allowed; }
    .top-bar { display: flex; justify-content: space-between; padding: 10px 20px; background: #007bff; color: white; }
    .top-bar button { background: red; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .top-bar .cart-btn { background: orange; margin-right: 10px; }
  </style>

  <link rel="stylesheet" href="/frontend/css/homeHeader.css">
  <link rel="stylesheet" href="/frontend/css/lightbox.css">
  <link rel="stylesheet" href="/frontend/css/zoomBadge.css">
</head>
<body>

  <div class="top-bar">
    <div>Bienvenido, <span id="nombreUsuario">...</span></div>
    <div>
      <button class="cart-btn" onclick="irCarrito()">Ir al Carrito</button>
      <button onclick="cerrarSesion()">Cerrar sesi칩n</button>
    </div>
  </div>

  <header>
    <h1>Productos Disponibles</h1>
  </header>

  <script src="/frontend/js/session.js"></script>
  <div id="app-header"></div>
  <script src="/frontend/js/homeHeader.js"></script>

  <div class="container" id="productosContainer"></div>

  <script>
    window.API_BASE = window.API_BASE || (window.API_BASE_URL || "http://127.0.0.1:5000").replace(/\/$/,"");

    const usuario = JSON.parse(localStorage.getItem('usuario') || "null");
    if (!usuario || !usuario.id_usuario) {
      alert("Debes iniciar sesi칩n primero.");
      window.location.href = "login.html";
    } else {
      document.getElementById('nombreUsuario').textContent = usuario.nombre || "";
    }

    function carritoKey() {
      return usuario && usuario.id_usuario ? `carrito_${usuario.id_usuario}` : "carrito";
    }
    function leerCarrito() {
      try { return JSON.parse(localStorage.getItem(carritoKey())) || []; } catch { return []; }
    }
    function guardarCarrito(arr) {
      localStorage.setItem(carritoKey(), JSON.stringify(arr));
    }

    async function cargarProductos() {
      const container = document.getElementById("productosContainer");
      container.innerHTML = "";

      const resp = await fetch(`${window.API_BASE}/api/products/list`);
      const productos = await resp.json();

      (productos || []).forEach(prod => {
        const stock = Number(prod.stock ?? prod.cantidad_actual ?? 0);
        const precio = Number(prod.precio_unitario || 0);
        const imgUrl = prod.imagen ? `${window.API_BASE}${prod.imagen}` : "/frontend/img/placeholder.png";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb">
            <img src="${imgUrl}" alt="${prod.nombre || ""}">
            <span class="zoom-badge" title="Ampliar">AMPLIAR IMAGEN</span>
          </div>
          <h3>${prod.nombre || ""}</h3>
          <p>${prod.descripcion || ""}</p>
          <p><b>Precio: Q${precio.toFixed(2)}</b></p>
          <p>Disponibles: ${stock}</p>
          <input type="number" min="1" max="${stock}" value="1" id="cantidad-${prod.id_producto}">
          <button id="btn-${prod.id_producto}" ${stock === 0 ? "disabled" : ""}>Agregar al Carrito</button>
        `;
        container.appendChild(card);

        document.getElementById(`btn-${prod.id_producto}`).addEventListener("click", () => {
          const cantidad = Math.max(1, parseInt(document.getElementById(`cantidad-${prod.id_producto}`).value, 10) || 1);
          if (cantidad > stock) { alert("No puedes agregar m치s de los disponibles."); return; }

          const carrito = leerCarrito();
          const idx = carrito.findIndex(it => Number(it.id_producto) === Number(prod.id_producto));
          if (idx >= 0) {
            if (carrito[idx].cantidad + cantidad > stock) { alert("No puedes agregar m치s de los disponibles."); return; }
            carrito[idx].cantidad += cantidad;
          } else {
            carrito.push({
              id_producto: Number(prod.id_producto),
              nombre: prod.nombre || "",
              descripcion: prod.descripcion || "",
              precio_unitario: precio,
              cantidad
            });
          }
          guardarCarrito(carrito);
          alert("Producto agregado al carrito.");
        });
      });

      if (typeof window.initZoomBadge === "function") window.initZoomBadge();
      if (typeof window.initLightbox === "function") window.initLightbox();
    }

    function irCarrito() { window.location.href = "carrito.html"; }
    function cerrarSesion() {
      localStorage.removeItem('usuario');
      localStorage.removeItem('token');
      window.location.href = "login.html";
    }

    cargarProductos();
  </script>

  <script src="/frontend/js/lightbox.js"></script>
  <script src="/frontend/js/autoZoom.js"></script>
</body>
</html>
